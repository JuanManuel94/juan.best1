<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>
                    <div id="content" class="content">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item">Fichas Hotspot</li>
                            <li class="breadcrumb-item active">Fichas</li>
                        </ol>
                        <h1 class="page-header">Fichas Hotspot <small>generación de vouchers</small></h1>
                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Fichas Generadas</h4>
                                <div class="panel-heading-btn">
                                    <button class="btn btn-primary btn-sm" data-toggle="modal"
                                        data-target="#modalVoucher">
                                        <i class="fa fa-plus"></i> Generar Fichas
                                    </button>
                                </div>
                            </div>
                            <div class="panel-body">
                                <table id="tableVouchers" class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>CÓDIGO</th>
                                            <th>PERFIL</th>
                                            <th>TIEMPO</th>
                                            <th>PRECIO</th>
                                            <th>ROUTER</th>
                                            <th>ESTADO</th>
                                            <th>ACCIONES</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
        </div>
        <div class="modal fade" id="modalVoucher" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Generar Fichas</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <form id="formVoucher">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Cantidad</label>
                                        <input type="number" class="form-control" name="count" value="10" min="1"
                                            max="100">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Precio</label>
                                        <input type="number" step="0.01" class="form-control" name="price" value="5.00">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Perfil/Plan</label>
                                <input type="text" class="form-control" name="profile" placeholder="1hr-5mb">
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Tiempo (minutos)</label>
                                        <input type="number" class="form-control" name="time_limit" value="60">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Router</label>
                                        <select class="form-control" name="routerid">
                                            <option value="">Todos</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Generar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <%- include('../resources/includes/footer') %>
            <script>
                $(document).ready(function () {
                    $('#tableVouchers').DataTable({
                        ajax: { url: '/hotspot/vouchers/list', dataSrc: 'data' },
                        columns: [
                            { data: 'id' }, { data: 'code' }, { data: 'profile', defaultContent: '-' }, { data: 'time_limit', render: d => d ? `${d} min` : '-' },
                            { data: 'price', render: d => d ? `S/ ${d}` : '-' }, { data: 'router_name', defaultContent: 'Todos' },
                            {
                                data: 'status', render: d => {
                                    const c = { available: 'success', used: 'secondary', expired: 'danger' };
                                    return `<span class="badge badge-${c[d] || 'secondary'}">${d}</span>`;
                                }
                            },
                            {
                                data: null, render: d => `
                        <button class="btn btn-info btn-xs" onclick="printVoucher('${d.code}')"><i class="fa fa-print"></i></button>
                        <button class="btn btn-danger btn-xs" onclick="deleteVoucher(${d.id})"><i class="fa fa-trash"></i></button>
                    `}
                        ],
                        language: { url: '/public/plugins/datatables/Spanish.json' }
                    });
                    $('#formVoucher').submit(function (e) {
                        e.preventDefault();
                        $.post('/hotspot/vouchers/create', $(this).serialize(), function (res) {
                            if (res.success) {
                                $('#modalVoucher').modal('hide');
                                $('#tableVouchers').DataTable().ajax.reload();
                                toastr.success(res.message);
                            } else { toastr.error(res.message); }
                        });
                    });
                });
                function printVoucher(code) { toastr.info('Imprimiendo ficha: ' + code); }
                function deleteVoucher(id) {
                    if (confirm('¿Eliminar esta ficha?')) {
                        $.post('/hotspot/vouchers/delete', { id }, function (res) {
                            if (res.success) { $('#tableVouchers').DataTable().ajax.reload(); toastr.success(res.message); }
                        });
                    }
                }
            </script>