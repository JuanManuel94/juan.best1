<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>

                    <div id="content" class="content">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="javascript:;">Finanzas</a></li>
                            <li class="breadcrumb-item active">Reportes de Pago</li>
                        </ol>
                        <h1 class="page-header">Reportes de Pago <small>análisis y estadísticas</small></h1>

                        <!-- Stats Cards -->
                        <div class="row">
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-teal">
                                    <div class="stats-icon"><i class="fa fa-calendar-day"></i></div>
                                    <div class="stats-info">
                                        <h4>INGRESOS HOY</h4>
                                        <p id="incomesToday">S/ 0.00</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;" data-filter="today">Ver detalle <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-blue">
                                    <div class="stats-icon"><i class="fa fa-receipt"></i></div>
                                    <div class="stats-info">
                                        <h4>PAGOS HOY</h4>
                                        <p id="paymentsToday">0</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;" data-filter="today">Ver detalle <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-green">
                                    <div class="stats-icon"><i class="fa fa-calendar-alt"></i></div>
                                    <div class="stats-info">
                                        <h4>INGRESOS MES</h4>
                                        <p id="incomesMonth">S/ 0.00</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;" data-filter="month">Ver detalle <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-orange">
                                    <div class="stats-icon"><i class="fa fa-exclamation-triangle"></i></div>
                                    <div class="stats-info">
                                        <h4>PENDIENTES</h4>
                                        <p id="pendingAmount">S/ 0.00</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="/bills">Ver facturas <i class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Report Panel -->
                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title"><i class="fa fa-chart-bar mr-2"></i>Reporte de Pagos</h4>
                                <div class="panel-heading-btn">
                                    <button class="btn btn-success btn-sm" id="btnExportExcel">
                                        <i class="fa fa-file-excel"></i> Exportar Excel
                                    </button>
                                    <button class="btn btn-danger btn-sm" id="btnExportPDF">
                                        <i class="fa fa-file-pdf"></i> Exportar PDF
                                    </button>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default"
                                        data-click="panel-expand"><i class="fa fa-expand"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <!-- Filtros -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-2">
                                        <label class="small text-muted">Desde</label>
                                        <input type="date" id="filterStartDate" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small text-muted">Hasta</label>
                                        <input type="date" id="filterEndDate" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small text-muted">Método</label>
                                        <select id="filterMethod" class="form-control form-control-sm">
                                            <option value="">Todos</option>
                                            <option value="cash">Efectivo</option>
                                            <option value="transfer">Transferencia</option>
                                            <option value="card">Tarjeta</option>
                                            <option value="yape">Yape</option>
                                            <option value="plin">Plin</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small text-muted">Usuario</label>
                                        <select id="filterUser" class="form-control form-control-sm">
                                            <option value="">Todos</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button id="btnFilter" class="btn btn-primary btn-sm btn-block">
                                            <i class="fa fa-search"></i> Filtrar
                                        </button>
                                    </div>
                                </div>

                                <!-- Resumen -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card border-left-success">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <small class="text-muted">Total Ingresos</small>
                                                        <h4 class="text-success mb-0" id="totalIncomes">S/ 0.00</h4>
                                                    </div>
                                                    <div class="text-success">
                                                        <i class="fa fa-arrow-up fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-left-danger">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <small class="text-muted">Total Egresos</small>
                                                        <h4 class="text-danger mb-0" id="totalExpenses">S/ 0.00</h4>
                                                    </div>
                                                    <div class="text-danger">
                                                        <i class="fa fa-arrow-down fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-left-primary">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <small class="text-muted">Balance</small>
                                                        <h4 class="text-primary mb-0" id="balance">S/ 0.00</h4>
                                                    </div>
                                                    <div class="text-primary">
                                                        <i class="fa fa-balance-scale fa-2x"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla -->
                                <div class="table-responsive">
                                    <table id="tablePayments" class="table table-striped table-bordered table-hover"
                                        style="width:100%">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>FECHA</th>
                                                <th>CLIENTE</th>
                                                <th>FACTURA</th>
                                                <th>MÉTODO</th>
                                                <th>USUARIO</th>
                                                <th>MONTO</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
        </div>

        <%- include('../resources/includes/footer') %>

            <style>
                .thead-dark th {
                    background-color: #2d353c;
                    color: #fff;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 11px;
                }

                .border-left-success {
                    border-left: 4px solid #00a65a !important;
                }

                .border-left-danger {
                    border-left: 4px solid #dc3545 !important;
                }

                .border-left-primary {
                    border-left: 4px solid #348fe2 !important;
                }

                .card {
                    border: 1px solid #e3e3e3;
                }
            </style>

            <script>
                $(document).ready(function () {
                    // Set default dates (first of month to today)
                    var today = new Date();
                    var firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    $('#filterStartDate').val(firstDay.toISOString().split('T')[0]);
                    $('#filterEndDate').val(today.toISOString().split('T')[0]);

                    // Load report data
                    function loadReportData() {
                        $.get('/finance/reports/data', {
                            start_date: $('#filterStartDate').val(),
                            end_date: $('#filterEndDate').val(),
                            method: $('#filterMethod').val(),
                            user: $('#filterUser').val()
                        }, function (res) {
                            if (res.success) {
                                $('#incomesToday').text('S/ ' + parseFloat(res.data.incomes_today || 0).toFixed(2));
                                $('#paymentsToday').text(res.data.payments_today || 0);
                                $('#incomesMonth').text('S/ ' + parseFloat(res.data.incomes_month || 0).toFixed(2));
                                $('#pendingAmount').text('S/ ' + parseFloat(res.data.pending || 0).toFixed(2));
                                $('#totalIncomes').text('S/ ' + parseFloat(res.data.total_incomes || 0).toFixed(2));
                                $('#totalExpenses').text('S/ ' + parseFloat(res.data.total_expenses || 0).toFixed(2));
                                var balance = (res.data.total_incomes || 0) - (res.data.total_expenses || 0);
                                $('#balance').text('S/ ' + balance.toFixed(2)).removeClass('text-danger text-success').addClass(balance >= 0 ? 'text-success' : 'text-danger');
                            }
                        });
                    }

                    // Initialize DataTable
                    var table = $('#tablePayments').DataTable({
                        ajax: {
                            url: '/finance/reports/data',
                            data: function (d) {
                                d.start_date = $('#filterStartDate').val();
                                d.end_date = $('#filterEndDate').val();
                                d.method = $('#filterMethod').val();
                            },
                            dataSrc: 'payments'
                        },
                        columns: [
                            { data: 'id' },
                            {
                                data: 'payment_date',
                                render: function (data) {
                                    return new Date(data).toLocaleDateString('es-PE');
                                }
                            },
                            { data: 'client_name' },
                            { data: 'invoice_number' },
                            {
                                data: 'payment_method',
                                render: function (data) {
                                    var methods = { cash: 'Efectivo', transfer: 'Transferencia', card: 'Tarjeta', yape: 'Yape', plin: 'Plin' };
                                    return methods[data] || data;
                                }
                            },
                            { data: 'user_name' },
                            {
                                data: 'amount',
                                render: function (data) {
                                    return '<span class="text-success font-weight-bold">S/ ' + parseFloat(data).toFixed(2) + '</span>';
                                }
                            }
                        ],
                        order: [[0, 'desc']],
                        language: { url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json' }
                    });

                    // Initial load
                    loadReportData();

                    // Filter
                    $('#btnFilter').click(function () {
                        loadReportData();
                        table.ajax.reload();
                    });

                    // Export buttons
                    $('#btnExportExcel').click(function () {
                        var params = $.param({
                            start_date: $('#filterStartDate').val(),
                            end_date: $('#filterEndDate').val(),
                            format: 'excel'
                        });
                        window.location.href = '/finance/reports/export?' + params;
                    });

                    $('#btnExportPDF').click(function () {
                        var params = $.param({
                            start_date: $('#filterStartDate').val(),
                            end_date: $('#filterEndDate').val(),
                            format: 'pdf'
                        });
                        window.location.href = '/finance/reports/export?' + params;
                    });
                });
            </script>
