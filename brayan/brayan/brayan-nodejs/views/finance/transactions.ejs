<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>

                    <div id="content" class="content">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="javascript:;">Finanzas</a></li>
                            <li class="breadcrumb-item active">Transacciones</li>
                        </ol>
                        <h1 class="page-header">Transacciones <small>historial de movimientos</small></h1>

                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Listado de Transacciones</h4>
                                <div class="panel-heading-btn">
                                    <button class="btn btn-primary btn-sm" data-toggle="modal"
                                        data-target="#modalTransaction">
                                        <i class="fa fa-plus"></i> Nueva Transacción
                                    </button>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default"
                                        data-click="panel-expand"><i class="fa fa-expand"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-success"
                                        data-click="panel-reload"><i class="fa fa-redo"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <!-- Filtros -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-2">
                                        <label class="small text-muted">Tipo</label>
                                        <select id="filterType" class="form-control form-control-sm">
                                            <option value="">Todos</option>
                                            <option value="income">Ingresos</option>
                                            <option value="expense">Egresos</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small text-muted">Desde</label>
                                        <input type="date" id="filterStartDate" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small text-muted">Hasta</label>
                                        <input type="date" id="filterEndDate" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small text-muted">Buscar</label>
                                        <input type="text" id="searchInput" class="form-control form-control-sm"
                                            placeholder="Buscar...">
                                    </div>
                                    <div class="col-md-2">
                                        <button id="btnFilter" class="btn btn-primary btn-sm btn-block">
                                            <i class="fa fa-search"></i> Filtrar
                                        </button>
                                    </div>
                                </div>

                                <!-- Tabla -->
                                <div class="table-responsive">
                                    <table id="tableTransactions" class="table table-striped table-bordered table-hover"
                                        style="width:100%">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>FECHA</th>
                                                <th>TIPO</th>
                                                <th>CATEGORÍA</th>
                                                <th>DESCRIPCIÓN</th>
                                                <th>CLIENTE</th>
                                                <th>MÉTODO</th>
                                                <th>MONTO</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Nueva Transacción -->
                    <div class="modal fade" id="modalTransaction" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="fa fa-exchange-alt mr-2"></i>Nueva Transacción
                                    </h5>
                                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                                </div>
                                <form id="formTransaction">
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-tag text-muted mr-1"></i> Tipo *</label>
                                                    <select name="type" class="form-control" required>
                                                        <option value="income">Ingreso</option>
                                                        <option value="expense">Egreso</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-calendar text-muted mr-1"></i> Fecha
                                                        *</label>
                                                    <input type="date" name="transaction_date" class="form-control"
                                                        required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-folder text-muted mr-1"></i>
                                                        Categoría</label>
                                                    <input type="text" name="category" class="form-control"
                                                        placeholder="Ej: Pago de servicio">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-dollar-sign text-muted mr-1"></i> Monto
                                                        *</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="number" name="amount" class="form-control"
                                                            step="0.01" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fa fa-align-left text-muted mr-1"></i> Descripción</label>
                                            <textarea name="description" class="form-control" rows="2"
                                                placeholder="Detalles de la transacción..."></textarea>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-credit-card text-muted mr-1"></i> Método de
                                                        Pago</label>
                                                    <select name="payment_method" class="form-control">
                                                        <option value="cash">Efectivo</option>
                                                        <option value="transfer">Transferencia</option>
                                                        <option value="card">Tarjeta</option>
                                                        <option value="yape">Yape</option>
                                                        <option value="plin">Plin</option>
                                                        <option value="check">Cheque</option>
                                                        <option value="other">Otro</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-hashtag text-muted mr-1"></i>
                                                        Referencia</label>
                                                    <input type="text" name="reference" class="form-control"
                                                        placeholder="# operación">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-white" data-dismiss="modal">
                                            <i class="fa fa-times"></i> Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save"></i> Guardar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
        </div>

        <%- include('../resources/includes/footer') %>

            <style>
                .thead-dark th {
                    background-color: #2d353c;
                    color: #fff;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 11px;
                }
            </style>

            <script>
                $(document).ready(function () {
                    // Set default date
                    var today = new Date().toISOString().split('T')[0];
                    $('input[name="transaction_date"]').val(today);

                    // Initialize DataTable
                    var table = $('#tableTransactions').DataTable({
                        ajax: { url: '/finance/transactions/list', dataSrc: 'data' },
                        columns: [
                            { data: 'id' },
                            {
                                data: 'transaction_date',
                                render: function (data) {
                                    return new Date(data).toLocaleDateString('es-PE');
                                }
                            },
                            {
                                data: 'type',
                                render: function (data) {
                                    return data === 'income' ?
                                        '<span class="badge badge-success">Ingreso</span>' :
                                        '<span class="badge badge-danger">Egreso</span>';
                                }
                            },
                            { data: 'category' },
                            { data: 'description' },
                            { data: 'client_name' },
                            {
                                data: 'payment_method',
                                render: function (data) {
                                    var methods = { cash: 'Efectivo', transfer: 'Transferencia', card: 'Tarjeta', yape: 'Yape', plin: 'Plin', check: 'Cheque', other: 'Otro' };
                                    return methods[data] || data;
                                }
                            },
                            {
                                data: 'amount',
                                render: function (data, type, row) {
                                    var color = row.type === 'income' ? 'text-success' : 'text-danger';
                                    var sign = row.type === 'income' ? '+' : '-';
                                    return '<span class="' + color + ' font-weight-bold">' + sign + ' S/ ' + parseFloat(data).toFixed(2) + '</span>';
                                }
                            }
                        ],
                        order: [[0, 'desc']],
                        language: { url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json' }
                    });

                    // Filter
                    $('#btnFilter').click(function () {
                        var params = $.param({
                            type: $('#filterType').val(),
                            start_date: $('#filterStartDate').val(),
                            end_date: $('#filterEndDate').val()
                        });
                        table.ajax.url('/finance/transactions/list?' + params).load();
                    });

                    // Search
                    $('#searchInput').on('keyup', function () {
                        table.search($(this).val()).draw();
                    });

                    // Form submit
                    $('#formTransaction').submit(function (e) {
                        e.preventDefault();
                        $.post('/finance/transactions/create', $(this).serialize(), function (res) {
                            if (res.success) {
                                $.gritter.add({ title: 'Éxito', text: res.message, class_name: 'gritter-success' });
                                $('#modalTransaction').modal('hide');
                                $('#formTransaction')[0].reset();
                                table.ajax.reload();
                            } else {
                                $.gritter.add({ title: 'Error', text: res.message, class_name: 'gritter-error' });
                            }
                        });
                    });
                });
            </script>
