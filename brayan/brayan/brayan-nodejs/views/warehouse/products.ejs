<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>

                    <div id="content" class="content">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="javascript:;">Almacén</a></li>
                            <li class="breadcrumb-item active">Productos</li>
                        </ol>
                        <h1 class="page-header">Inventario <small>gestión de productos</small></h1>

                        <!-- Stats Cards -->
                        <div class="row">
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-blue">
                                    <div class="stats-icon"><i class="fa fa-boxes"></i></div>
                                    <div class="stats-info">
                                        <h4>TOTAL PRODUCTOS</h4>
                                        <p id="totalProducts">0</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;">Ver todos <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-teal">
                                    <div class="stats-icon"><i class="fa fa-check-circle"></i></div>
                                    <div class="stats-info">
                                        <h4>EN STOCK</h4>
                                        <p id="inStock">0</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;">Ver detalle <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-orange">
                                    <div class="stats-icon"><i class="fa fa-exclamation-triangle"></i></div>
                                    <div class="stats-info">
                                        <h4>STOCK BAJO</h4>
                                        <p id="lowStock">0</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;">Ver productos <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="widget widget-stats bg-red">
                                    <div class="stats-icon"><i class="fa fa-times-circle"></i></div>
                                    <div class="stats-info">
                                        <h4>SIN STOCK</h4>
                                        <p id="outOfStock">0</p>
                                    </div>
                                    <div class="stats-link">
                                        <a href="javascript:;">Ver productos <i
                                                class="fa fa-arrow-alt-circle-right"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title"><i class="fa fa-box-open mr-2"></i>Lista de Productos</h4>
                                <div class="panel-heading-btn">
                                    <button class="btn btn-primary btn-sm" data-toggle="modal"
                                        data-target="#modalProduct">
                                        <i class="fa fa-plus"></i> Nuevo Producto
                                    </button>
                                    <button class="btn btn-success btn-sm" id="btnExport">
                                        <i class="fa fa-file-excel"></i> Exportar
                                    </button>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default"
                                        data-click="panel-expand"><i class="fa fa-expand"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <!-- Filters -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-2">
                                        <label class="small text-muted">Categoría</label>
                                        <select id="filterCategory" class="form-control form-control-sm">
                                            <option value="">Todas</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="small text-muted">Estado Stock</label>
                                        <select id="filterStock" class="form-control form-control-sm">
                                            <option value="">Todos</option>
                                            <option value="in_stock">En stock</option>
                                            <option value="low_stock">Stock bajo</option>
                                            <option value="out_of_stock">Sin stock</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="small text-muted">Buscar</label>
                                        <input type="text" id="searchInput" class="form-control form-control-sm"
                                            placeholder="Nombre, código, descripción...">
                                    </div>
                                    <div class="col-md-2">
                                        <button id="btnFilter" class="btn btn-primary btn-sm btn-block">
                                            <i class="fa fa-search"></i> Filtrar
                                        </button>
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table id="tableProducts" class="table table-striped table-bordered table-hover"
                                        style="width:100%">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th width="60">CÓDIGO</th>
                                                <th>PRODUCTO</th>
                                                <th>CATEGORÍA</th>
                                                <th>PROVEEDOR</th>
                                                <th width="80">STOCK</th>
                                                <th width="100">PRECIO</th>
                                                <th width="100">COSTO</th>
                                                <th width="100">ACCIONES</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Nuevo Producto -->
                    <div class="modal fade" id="modalProduct" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="fa fa-box mr-2"></i>Nuevo Producto</h5>
                                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                                </div>
                                <form id="formProduct">
                                    <input type="hidden" name="id" id="productId">
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-barcode text-muted mr-1"></i> Código
                                                        *</label>
                                                    <input type="text" name="code" class="form-control"
                                                        placeholder="SKU-001" required>
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label><i class="fa fa-font text-muted mr-1"></i> Nombre *</label>
                                                    <input type="text" name="name" class="form-control"
                                                        placeholder="Nombre del producto" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-tag text-muted mr-1"></i> Categoría *</label>
                                                    <select name="categoryid" class="form-control" required>
                                                        <option value="">Seleccionar...</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-truck text-muted mr-1"></i> Proveedor</label>
                                                    <select name="supplierid" class="form-control">
                                                        <option value="">Seleccionar...</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label><i class="fa fa-cubes text-muted mr-1"></i> Stock *</label>
                                                    <input type="number" name="stock" class="form-control" value="0"
                                                        min="0" required>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label><i class="fa fa-exclamation text-muted mr-1"></i> Stock
                                                        Mínimo</label>
                                                    <input type="number" name="min_stock" class="form-control" value="5"
                                                        min="0">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label><i class="fa fa-dollar-sign text-muted mr-1"></i> Precio
                                                        Venta *</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="number" name="price" class="form-control"
                                                            step="0.01" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    <label><i class="fa fa-receipt text-muted mr-1"></i> Costo</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="number" name="cost" class="form-control"
                                                            step="0.01">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-ruler text-muted mr-1"></i> Unidad</label>
                                                    <select name="unit" class="form-control">
                                                        <option value="unit">Unidad</option>
                                                        <option value="meter">Metro</option>
                                                        <option value="kg">Kilogramo</option>
                                                        <option value="box">Caja</option>
                                                        <option value="roll">Rollo</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-map-marker text-muted mr-1"></i>
                                                        Ubicación</label>
                                                    <input type="text" name="location" class="form-control"
                                                        placeholder="Estante A-1">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-toggle-on text-muted mr-1"></i>
                                                        Estado</label>
                                                    <select name="state" class="form-control">
                                                        <option value="1">Activo</option>
                                                        <option value="0">Inactivo</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label><i class="fa fa-align-left text-muted mr-1"></i> Descripción</label>
                                            <textarea name="description" class="form-control" rows="2"
                                                placeholder="Descripción del producto..."></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-white" data-dismiss="modal">
                                            <i class="fa fa-times"></i> Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save"></i> Guardar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
        </div>

        <%- include('../resources/includes/footer') %>

            <style>
                .thead-dark th {
                    background-color: #2d353c;
                    color: #fff;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 11px;
                    letter-spacing: 0.5px;
                }

                .badge-stock-ok {
                    background-color: #00acac;
                    color: #fff;
                }

                .badge-stock-low {
                    background-color: #f59c1a;
                    color: #fff;
                }

                .badge-stock-out {
                    background-color: #ff5b57;
                    color: #fff;
                }
            </style>

            <script>
                $(document).ready(function () {
                    // Load categories for filter and form
                    $.get('/warehouse/categories/list', function (res) {
                        if (res.data) {
                            var options = '<option value="">Seleccionar...</option>';
                            var filterOptions = '<option value="">Todas</option>';
                            res.data.forEach(function (cat) {
                                options += '<option value="' + cat.id + '">' + cat.name + '</option>';
                                filterOptions += '<option value="' + cat.id + '">' + cat.name + '</option>';
                            });
                            $('select[name="categoryid"]').html(options);
                            $('#filterCategory').html(filterOptions);
                        }
                    });

                    // Load suppliers for form
                    $.get('/warehouse/suppliers/list', function (res) {
                        if (res.data) {
                            var options = '<option value="">Seleccionar...</option>';
                            res.data.forEach(function (sup) {
                                options += '<option value="' + sup.id + '">' + sup.business_name + '</option>';
                            });
                            $('select[name="supplierid"]').html(options);
                        }
                    });

                    // Initialize DataTable
                    var table = $('#tableProducts').DataTable({
                        ajax: { url: '/warehouse/products/list', dataSrc: 'data' },
                        columns: [
                            {
                                data: 'code',
                                render: function (data) {
                                    return '<span class="badge badge-secondary">' + data + '</span>';
                                }
                            },
                            {
                                data: 'name',
                                render: function (data, type, row) {
                                    var html = '<strong>' + data + '</strong>';
                                    if (row.description) {
                                        html += '<br><small class="text-muted">' + row.description.substring(0, 50) + '...</small>';
                                    }
                                    return html;
                                }
                            },
                            { data: 'category_name' },
                            { data: 'supplier_name' },
                            {
                                data: 'stock',
                                render: function (data, type, row) {
                                    var minStock = row.min_stock || 5;
                                    var badgeClass = 'badge-stock-ok';
                                    if (data <= 0) {
                                        badgeClass = 'badge-stock-out';
                                    } else if (data <= minStock) {
                                        badgeClass = 'badge-stock-low';
                                    }
                                    return '<span class="badge ' + badgeClass + '">' + data + '</span>';
                                }
                            },
                            {
                                data: 'price',
                                render: function (data) {
                                    return '<span class="text-success font-weight-bold">S/ ' + parseFloat(data).toFixed(2) + '</span>';
                                }
                            },
                            {
                                data: 'cost',
                                render: function (data) {
                                    return data ? 'S/ ' + parseFloat(data).toFixed(2) : '-';
                                }
                            },
                            {
                                data: null,
                                orderable: false,
                                render: function (data) {
                                    return '<div class="btn-group btn-group-sm">' +
                                        '<button class="btn btn-info btn-edit" data-id="' + data.id + '" title="Editar"><i class="fa fa-edit"></i></button>' +
                                        '<button class="btn btn-success btn-stock" data-id="' + data.id + '" title="Ajustar stock"><i class="fa fa-cubes"></i></button>' +
                                        '<button class="btn btn-danger btn-delete" data-id="' + data.id + '" title="Eliminar"><i class="fa fa-trash"></i></button>' +
                                        '</div>';
                                }
                            }
                        ],
                        order: [[0, 'desc']],
                        language: { url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json' }
                    });

                    // Search
                    $('#searchInput').on('keyup', function () {
                        table.search($(this).val()).draw();
                    });

                    // Filter
                    $('#btnFilter').click(function () {
                        var params = $.param({
                            category: $('#filterCategory').val(),
                            stock_status: $('#filterStock').val()
                        });
                        table.ajax.url('/warehouse/products/list?' + params).load();
                    });

                    // Form submit
                    $('#formProduct').submit(function (e) {
                        e.preventDefault();
                        var id = $('#productId').val();
                        var url = id ? '/warehouse/products/update' : '/warehouse/products/create';
                        $.post(url, $(this).serialize(), function (res) {
                            if (res.success) {
                                $.gritter.add({ title: 'Éxito', text: res.message, class_name: 'gritter-success' });
                                $('#modalProduct').modal('hide');
                                $('#formProduct')[0].reset();
                                $('#productId').val('');
                                table.ajax.reload();
                            } else {
                                $.gritter.add({ title: 'Error', text: res.message, class_name: 'gritter-error' });
                            }
                        });
                    });

                    // Edit product
                    $(document).on('click', '.btn-edit', function () {
                        var id = $(this).data('id');
                        $.get('/warehouse/products/select/' + id, function (res) {
                            if (res.success) {
                                var prod = res.data;
                                $('#productId').val(prod.id);
                                $('input[name="code"]').val(prod.code);
                                $('input[name="name"]').val(prod.name);
                                $('select[name="categoryid"]').val(prod.categoryid);
                                $('select[name="supplierid"]').val(prod.supplierid);
                                $('input[name="stock"]').val(prod.stock);
                                $('input[name="min_stock"]').val(prod.min_stock);
                                $('input[name="price"]').val(prod.price);
                                $('input[name="cost"]').val(prod.cost);
                                $('select[name="unit"]').val(prod.unit);
                                $('input[name="location"]').val(prod.location);
                                $('select[name="state"]').val(prod.state);
                                $('textarea[name="description"]').val(prod.description);
                                $('.modal-title').html('<i class="fa fa-edit mr-2"></i>Editar Producto');
                                $('#modalProduct').modal('show');
                            }
                        });
                    });

                    // Delete product
                    $(document).on('click', '.btn-delete', function () {
                        var id = $(this).data('id');
                        $.confirm({
                            title: '<i class="fa fa-trash text-danger"></i> Eliminar Producto',
                            content: '¿Está seguro de eliminar este producto?',
                            type: 'red',
                            buttons: {
                                eliminar: {
                                    btnClass: 'btn-danger',
                                    action: function () {
                                        $.post('/warehouse/products/delete', { id: id }, function (res) {
                                            if (res.success) {
                                                $.gritter.add({ title: 'Éxito', text: res.message, class_name: 'gritter-success' });
                                                table.ajax.reload();
                                            } else {
                                                $.gritter.add({ title: 'Error', text: res.message, class_name: 'gritter-error' });
                                            }
                                        });
                                    }
                                },
                                cancelar: function () { }
                            }
                        });
                    });

                    // Reset modal on close
                    $('#modalProduct').on('hidden.bs.modal', function () {
                        $('#formProduct')[0].reset();
                        $('#productId').val('');
                        $('.modal-title').html('<i class="fa fa-box mr-2"></i>Nuevo Producto');
                    });
                });
            </script>
