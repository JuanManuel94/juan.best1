<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>

                    <div id="content" class="content">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item"><a href="javascript:;">Almacén</a></li>
                            <li class="breadcrumb-item active">Proveedores</li>
                        </ol>
                        <h1 class="page-header">Proveedores <small>listado</small></h1>

                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title"><i class="fa fa-truck mr-2"></i>Lista de Proveedores</h4>
                                <div class="panel-heading-btn">
                                    <button class="btn btn-primary btn-sm" data-toggle="modal"
                                        data-target="#modalSupplier">
                                        <i class="fa fa-plus"></i> Nuevo Proveedor
                                    </button>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default"
                                        data-click="panel-expand"><i class="fa fa-expand"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-success"
                                        data-click="panel-reload"><i class="fa fa-redo"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table id="tableSuppliers" class="table table-striped table-bordered table-hover"
                                        style="width:100%">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th width="50">ID</th>
                                                <th>NOMBRE</th>
                                                <th>RUC</th>
                                                <th>CONTACTO</th>
                                                <th>TELÉFONO</th>
                                                <th>EMAIL</th>
                                                <th width="100">ACCIONES</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Nuevo Proveedor -->
                    <div class="modal fade" id="modalSupplier" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="fa fa-truck mr-2"></i>Nuevo Proveedor</h5>
                                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                                </div>
                                <form id="formSupplier">
                                    <input type="hidden" name="id" id="supplierId">
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-building text-muted mr-1"></i> Razón Social
                                                        *</label>
                                                    <input type="text" name="business_name" class="form-control"
                                                        placeholder="Nombre de la empresa" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label><i class="fa fa-store text-muted mr-1"></i> Nombre
                                                        Comercial</label>
                                                    <input type="text" name="trade_name" class="form-control"
                                                        placeholder="Nombre comercial">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-id-card text-muted mr-1"></i> RUC *</label>
                                                    <input type="text" name="ruc" class="form-control"
                                                        placeholder="20123456789" maxlength="11" required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-user text-muted mr-1"></i> Persona de
                                                        Contacto</label>
                                                    <input type="text" name="contact_person" class="form-control"
                                                        placeholder="Nombre del contacto">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-clock text-muted mr-1"></i> Condiciones de
                                                        Pago</label>
                                                    <input type="text" name="payment_terms" class="form-control"
                                                        placeholder="Ej: 30 días">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-phone text-muted mr-1"></i> Teléfono</label>
                                                    <input type="text" name="phone" class="form-control"
                                                        placeholder="01 999 9999">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-mobile-alt text-muted mr-1"></i>
                                                        Celular</label>
                                                    <input type="text" name="mobile" class="form-control"
                                                        placeholder="999 999 999">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-envelope text-muted mr-1"></i> Email</label>
                                                    <input type="email" name="email" class="form-control"
                                                        placeholder="proveedor@empresa.com">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-globe text-muted mr-1"></i> Sitio Web</label>
                                                    <input type="url" name="website" class="form-control"
                                                        placeholder="https://www.empresa.com">
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label><i class="fa fa-map-marker-alt text-muted mr-1"></i>
                                                        Dirección</label>
                                                    <input type="text" name="address" class="form-control"
                                                        placeholder="Dirección completa">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label><i class="fa fa-city text-muted mr-1"></i> Ciudad</label>
                                                    <input type="text" name="city" class="form-control"
                                                        placeholder="Ciudad">
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label><i class="fa fa-sticky-note text-muted mr-1"></i>
                                                        Notas</label>
                                                    <textarea name="notes" class="form-control" rows="2"
                                                        placeholder="Notas adicionales..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-white" data-dismiss="modal">
                                            <i class="fa fa-times"></i> Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fa fa-save"></i> Guardar
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
        </div>

        <%- include('../resources/includes/footer') %>

            <style>
                .thead-dark th {
                    background-color: #2d353c;
                    color: #fff;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 11px;
                    letter-spacing: 0.5px;
                }
            </style>

            <script>
                $(document).ready(function () {
                    // Initialize DataTable
                    var table = $('#tableSuppliers').DataTable({
                        ajax: { url: '/warehouse/suppliers/list', dataSrc: 'data' },
                        columns: [
                            { data: 'id' },
                            {
                                data: 'business_name',
                                render: function (data, type, row) {
                                    var html = '<strong>' + data + '</strong>';
                                    if (row.trade_name) {
                                        html += '<br><small class="text-muted">' + row.trade_name + '</small>';
                                    }
                                    return html;
                                }
                            },
                            {
                                data: 'ruc',
                                render: function (data) {
                                    return '<span class="badge badge-secondary"><i class="fa fa-id-card mr-1"></i>' + data + '</span>';
                                }
                            },
                            {
                                data: 'contact_person',
                                render: function (data) {
                                    return data || '<span class="text-muted">-</span>';
                                }
                            },
                            {
                                data: 'phone',
                                render: function (data, type, row) {
                                    if (data || row.mobile) {
                                        return '<i class="fa fa-phone text-success mr-1"></i>' + (data || row.mobile);
                                    }
                                    return '<span class="text-muted">-</span>';
                                }
                            },
                            {
                                data: 'email',
                                render: function (data) {
                                    if (data) {
                                        return '<a href="mailto:' + data + '">' + data + '</a>';
                                    }
                                    return '<span class="text-muted">-</span>';
                                }
                            },
                            {
                                data: null,
                                orderable: false,
                                render: function (data) {
                                    return '<div class="btn-group btn-group-sm">' +
                                        '<button class="btn btn-info btn-edit" data-id="' + data.id + '" title="Editar"><i class="fa fa-edit"></i></button>' +
                                        '<button class="btn btn-danger btn-delete" data-id="' + data.id + '" title="Eliminar"><i class="fa fa-trash"></i></button>' +
                                        '</div>';
                                }
                            }
                        ],
                        order: [[0, 'desc']],
                        language: { url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json' }
                    });

                    // Form submit
                    $('#formSupplier').submit(function (e) {
                        e.preventDefault();
                        var id = $('#supplierId').val();
                        var url = id ? '/warehouse/suppliers/update' : '/warehouse/suppliers/create';
                        $.post(url, $(this).serialize(), function (res) {
                            if (res.success) {
                                $.gritter.add({ title: 'Éxito', text: res.message, class_name: 'gritter-success' });
                                $('#modalSupplier').modal('hide');
                                $('#formSupplier')[0].reset();
                                $('#supplierId').val('');
                                table.ajax.reload();
                            } else {
                                $.gritter.add({ title: 'Error', text: res.message, class_name: 'gritter-error' });
                            }
                        });
                    });

                    // Edit supplier
                    $(document).on('click', '.btn-edit', function () {
                        var id = $(this).data('id');
                        $.get('/warehouse/suppliers/select/' + id, function (res) {
                            if (res.success) {
                                var sup = res.data;
                                $('#supplierId').val(sup.id);
                                $('input[name="business_name"]').val(sup.business_name);
                                $('input[name="trade_name"]').val(sup.trade_name);
                                $('input[name="ruc"]').val(sup.ruc);
                                $('input[name="contact_person"]').val(sup.contact_person);
                                $('input[name="payment_terms"]').val(sup.payment_terms);
                                $('input[name="phone"]').val(sup.phone);
                                $('input[name="mobile"]').val(sup.mobile);
                                $('input[name="email"]').val(sup.email);
                                $('input[name="website"]').val(sup.website);
                                $('input[name="address"]').val(sup.address);
                                $('input[name="city"]').val(sup.city);
                                $('textarea[name="notes"]').val(sup.notes);
                                $('.modal-title').html('<i class="fa fa-edit mr-2"></i>Editar Proveedor');
                                $('#modalSupplier').modal('show');
                            }
                        });
                    });

                    // Delete supplier
                    $(document).on('click', '.btn-delete', function () {
                        var id = $(this).data('id');
                        $.confirm({
                            title: '<i class="fa fa-trash text-danger"></i> Eliminar Proveedor',
                            content: '¿Está seguro de eliminar este proveedor?',
                            type: 'red',
                            buttons: {
                                eliminar: {
                                    btnClass: 'btn-danger',
                                    action: function () {
                                        $.post('/warehouse/suppliers/delete', { id: id }, function (res) {
                                            if (res.success) {
                                                $.gritter.add({ title: 'Éxito', text: res.message, class_name: 'gritter-success' });
                                                table.ajax.reload();
                                            } else {
                                                $.gritter.add({ title: 'Error', text: res.message, class_name: 'gritter-error' });
                                            }
                                        });
                                    }
                                },
                                cancelar: function () { }
                            }
                        });
                    });

                    // Reset modal on close
                    $('#modalSupplier').on('hidden.bs.modal', function () {
                        $('#formSupplier')[0].reset();
                        $('#supplierId').val('');
                        $('.modal-title').html('<i class="fa fa-truck mr-2"></i>Nuevo Proveedor');
                    });
                });
            </script>
