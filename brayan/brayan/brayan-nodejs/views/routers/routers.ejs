<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>

                    <div id="content" class="content" style="background: #d9e0e7;">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item">Gestión de Red</li>
                            <li class="breadcrumb-item active">Routers</li>
                        </ol>
                        <h1 class="page-header">Routers <small>administración de equipos Mikrotik</small></h1>

                        <!-- Panel MikroWISP Style -->
                        <div class="mw-panel">
                            <div class="mw-panel-header">
                                <h4 class="mw-panel-title">Lista de Router</h4>
                                <div class="mw-panel-controls">
                                    <button class="btn-control btn-add" data-toggle="modal" data-target="#modalRouter"
                                        title="Agregar">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                    <button class="btn-control btn-refresh" onclick="reloadRouters()" title="Refrescar">
                                        <i class="fa fa-sync"></i>
                                    </button>
                                    <button class="btn-control btn-minimize" title="Minimizar">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mw-panel-body">
                                <!-- Toolbar -->
                                <div class="mw-toolbar">
                                    <div class="mw-toolbar-left">
                                        <div class="mw-page-size">
                                            <select id="pageSize" onchange="changePageSize()">
                                                <option value="15">15</option>
                                                <option value="25">25</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                            <button class="btn-list"><i class="fa fa-list"></i></button>
                                        </div>
                                        <button class="mw-btn-new" data-toggle="modal" data-target="#modalRouter">
                                            <i class="fa fa-plus"></i> Nuevo
                                        </button>
                                    </div>
                                    <div class="mw-toolbar-right">
                                        <div class="mw-search">
                                            <input type="text" id="searchRouter" placeholder="Buscar..."
                                                onkeyup="searchRouters()">
                                            <i class="fa fa-search"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Table -->
                                <div class="mw-table-container">
                                    <table id="tableRouters" class="mw-table">
                                        <thead>
                                            <tr>
                                                <th width="5%" class="sortable">ID <i class="fa fa-sort sort-icon"></i>
                                                </th>
                                                <th class="sortable">NOMBRE <i class="fa fa-sort-down sort-icon"></i>
                                                </th>
                                                <th class="sortable">IP <i class="fa fa-sort sort-icon"></i></th>
                                                <th class="sortable">MODELO <i class="fa fa-sort sort-icon"></i></th>
                                                <th class="sortable">VERSIÓN <i class="fa fa-sort sort-icon"></i></th>
                                                <th class="text-center sortable">CLIENTES <i
                                                        class="fa fa-sort sort-icon"></i></th>
                                                <th class="text-center sortable">ESTADO <i
                                                        class="fa fa-sort sort-icon"></i></th>
                                                <th width="12%"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="routersBody">
                                            <!-- Data will be loaded via JavaScript -->
                                        </tbody>
                                    </table>

                                    <!-- Pagination -->
                                    <div class="mw-pagination">
                                        <span class="mw-pagination-info">
                                            Mostrando de <a href="#">1</a> al <a href="#">2</a> de un total de <span
                                                id="totalRouters">2</span>
                                        </span>
                                        <button class="mw-page-btn" id="prevPage"><i
                                                class="fa fa-chevron-left"></i></button>
                                        <button class="mw-page-btn active">1</button>
                                        <button class="mw-page-btn" id="nextPage"><i
                                                class="fa fa-chevron-right"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Icon -->
                        <div style="position: fixed; right: 20px; bottom: 20px;">
                            <button class="mw-settings-icon" style="width: 40px; height: 40px;">
                                <i class="fa fa-cog"></i>
                            </button>
                        </div>
                    </div>
        </div>

        <!-- Modal Nuevo/Editar Router -->
        <div class="modal fade" id="modalRouter" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Nuevo Router</h5>
                        <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                    </div>
                    <form id="formRouter">
                        <div class="modal-body">
                            <input type="hidden" name="id" id="router_id">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Nombre</label>
                                        <input type="text" class="form-control" name="name" id="name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Dirección IP</label>
                                        <input type="text" class="form-control" name="ip_address" id="ip_address"
                                            required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Puerto API</label>
                                        <input type="number" class="form-control" name="api_port" id="api_port"
                                            value="8728">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Usuario API</label>
                                        <input type="text" class="form-control" name="api_user" id="api_user">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Contraseña API</label>
                                        <input type="password" class="form-control" name="api_password"
                                            id="api_password">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Identidad</label>
                                        <input type="text" class="form-control" name="identity" id="identity"
                                            placeholder="Nombre del router en MikroTik">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Modelo</label>
                                        <input type="text" class="form-control" name="board" id="board"
                                            placeholder="ej: CHR, RB750, CCR1009">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <%- include('../resources/includes/footer') %>

            <script>
                let routersData = [];

                $(document).ready(function () {
                    loadRouters();
                });

                function loadRouters() {
                    $.get('/network/routers/list', function (response) {
                        routersData = response.data || [];
                        renderRouters(routersData);
                    }).fail(function () {
                        // Demo data if API fails
                        routersData = [
                            { id: 2, name: 'Router Demo', subtitle: 'PPPoE Radius + PCQ', ip_address: '45.77.1.85', board: 'CHR', version: '6.45.1 (stable)', clients: 32, status: 'online' },
                            { id: 1, name: 'Router Principal', subtitle: 'Api + Dhcp Leases + PCQ', ip_address: '45.63.89.72', board: 'CHR', version: '6.45.1 (stable)', clients: 28, status: 'online' }
                        ];
                        renderRouters(routersData);
                    });
                }

                function renderRouters(data) {
                    const tbody = $('#routersBody');
                    tbody.empty();

                    data.forEach(router => {
                        const statusBadge = router.status === 'online'
                            ? '<span class="mw-badge mw-badge-conectado">CONECTADO</span>'
                            : '<span class="mw-badge mw-badge-desconectado">DESCONECTADO</span>';

                        const clientsBadge = `<span class="mw-badge-circle blue">${router.clients || 0}</span>`;

                        tbody.append(`
                            <tr>
                                <td>${router.id}</td>
                                <td>
                                    <div class="mw-router-name">
                                        <span class="name">${router.name}</span>
                                        <span class="subtitle">${router.subtitle || router.identity || ''}</span>
                                    </div>
                                </td>
                                <td>${router.ip_address}</td>
                                <td>${router.board || '-'}</td>
                                <td>${router.version || '-'}</td>
                                <td class="text-center">${clientsBadge}</td>
                                <td class="text-center">${statusBadge}</td>
                                <td>
                                    <div class="mw-actions">
                                        <button class="mw-btn-action edit" onclick="editRouter(${router.id})" title="Editar">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button class="mw-btn-action delete" onclick="deleteRouter(${router.id})" title="Eliminar">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                        <button class="mw-btn-action users" title="Ver clientes">
                                            <i class="fa fa-users"></i>
                                        </button>
                                        <button class="mw-btn-action tools" title="Herramientas">
                                            <i class="fa fa-wrench"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    });

                    $('#totalRouters').text(data.length);
                }

                function reloadRouters() {
                    toastr.info('Actualizando lista de routers...');
                    loadRouters();
                    setTimeout(() => toastr.success('Lista actualizada'), 1000);
                }

                function searchRouters() {
                    const term = $('#searchRouter').val().toLowerCase();
                    const filtered = routersData.filter(r =>
                        r.name.toLowerCase().includes(term) ||
                        r.ip_address.includes(term)
                    );
                    renderRouters(filtered);
                }

                function changePageSize() {
                    // Pagination logic here
                }

                function editRouter(id) {
                    $.get('/network/routers/select/' + id, function (data) {
                        $('#router_id').val(data.id);
                        $('#name').val(data.name);
                        $('#ip_address').val(data.ip_address);
                        $('#api_port').val(data.api_port);
                        $('#api_user').val(data.api_user);
                        $('#api_password').val('');
                        $('#identity').val(data.identity);
                        $('#board').val(data.board);
                        $('#modalRouter').modal('show');
                    }).fail(function () {
                        toastr.error('Error al cargar datos del router');
                    });
                }

                function deleteRouter(id) {
                    if (confirm('¿Está seguro de eliminar este router?')) {
                        $.post('/network/routers/delete', { id: id }, function (res) {
                            if (res.success) {
                                loadRouters();
                                toastr.success(res.message || 'Router eliminado');
                            } else {
                                toastr.error(res.message || 'Error al eliminar');
                            }
                        });
                    }
                }

                $('#formRouter').on('submit', function (e) {
                    e.preventDefault();
                    const id = $('#router_id').val();
                    const url = id ? '/network/routers/update' : '/network/routers/create';
                    $.post(url, $(this).serialize(), function (res) {
                        if (res.success) {
                            $('#modalRouter').modal('hide');
                            loadRouters();
                            toastr.success(res.message || 'Router guardado');
                            $('#formRouter')[0].reset();
                            $('#router_id').val('');
                        } else {
                            toastr.error(res.message || 'Error al guardar');
                        }
                    });
                });

                $('#modalRouter').on('hidden.bs.modal', function () {
                    $('#formRouter')[0].reset();
                    $('#router_id').val('');
                });
            </script>