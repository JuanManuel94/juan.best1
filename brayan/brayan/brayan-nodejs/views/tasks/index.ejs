<%- include('../resources/includes/head') %>

    <body>
        <div id="page-container" class="fade page-sidebar-fixed page-header-fixed">
            <%- include('../resources/includes/header') %>
                <%- include('../resources/includes/sidebar') %>

                    <div id="content" class="content">
                        <ol class="breadcrumb float-xl-right">
                            <li class="breadcrumb-item"><a href="/dashboard">Inicio</a></li>
                            <li class="breadcrumb-item active">Tareas</li>
                        </ol>
                        <h1 class="page-header">Tareas</h1>

                        <div class="panel panel-inverse">
                            <div class="panel-heading">
                                <h4 class="panel-title">Gestión de Tareas</h4>
                                <div class="panel-heading-btn">
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default"
                                        data-click="panel-expand"><i class="fa fa-expand"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-success"
                                        data-click="panel-reload"><i class="fa fa-redo"></i></a>
                                    <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning"
                                        data-click="panel-collapse"><i class="fa fa-minus"></i></a>
                                </div>
                            </div>
                            <div class="panel-body">
                                <!-- Action Bar -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <button class="btn btn-primary" data-toggle="modal" data-target="#modalTask">
                                            <i class="fa fa-plus"></i> Agregar Tarea
                                        </button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-white active" id="btnAllTasks">
                                            Todas las tareas
                                        </button>
                                        <button type="button" class="btn btn-white" id="btnMyTasks">
                                            Mis Tareas
                                        </button>
                                        <button type="button" class="btn btn-white" id="btnTimeline">
                                            Cronología
                                        </button>
                                        <button type="button" class="btn btn-primary" id="btnTasksView">
                                            Tareas
                                        </button>
                                    </div>
                                </div>

                                <!-- Filters Row -->
                                <div class="row mb-3 align-items-end">
                                    <div class="col-md-1">
                                        <select id="entriesPerPage" class="form-control form-control-sm">
                                            <option value="10">10</option>
                                            <option value="15" selected>15</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1 text-center">
                                        <button class="btn btn-sm btn-default"><i class="fa fa-list"></i></button>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="date" id="filterDate" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-2">
                                        <select id="filterStatus" class="form-control form-control-sm">
                                            <option value="">Estado</option>
                                            <option value="pending">Pendiente</option>
                                            <option value="in_progress">En proceso</option>
                                            <option value="completed">Completado</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" id="searchInput" class="form-control form-control-sm"
                                            placeholder="Buscar...">
                                    </div>
                                </div>

                                <!-- Tasks Table -->
                                <div class="table-responsive">
                                    <table id="tableTasks" class="table table-striped table-bordered table-hover"
                                        style="width:100%">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>TÍTULO</th>
                                                <th>ESTADO</th>
                                                <th>FECHA</th>
                                                <th>DURACIÓN</th>
                                                <th>OPERADOR</th>
                                                <th>CLIENTE</th>
                                                <th width="100">ACCIONES</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Nueva Tarea -->
                    <div class="modal fade" id="modalTask" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="fa fa-tasks mr-2"></i>Nueva Tarea</h5>
                                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                                </div>
                                <form id="formTask">
                                    <input type="hidden" name="id" id="taskId">
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label>Título *</label>
                                                    <input type="text" name="title" class="form-control"
                                                        placeholder="Título de la tarea" required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Estado</label>
                                                    <select name="status" class="form-control">
                                                        <option value="pending">Pendiente</option>
                                                        <option value="in_progress">En proceso</option>
                                                        <option value="completed">Completado</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Fecha *</label>
                                                    <input type="datetime-local" name="due_date" class="form-control"
                                                        required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Duración</label>
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <select name="duration_hours" class="form-control">
                                                                <option value="0">0 hrs</option>
                                                                <option value="1" selected>1 hr</option>
                                                                <option value="2">2 hrs</option>
                                                                <option value="3">3 hrs</option>
                                                                <option value="4">4 hrs</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-6">
                                                            <select name="duration_minutes" class="form-control">
                                                                <option value="0">0 min</option>
                                                                <option value="15">15 min</option>
                                                                <option value="30">30 min</option>
                                                                <option value="45">45 min</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Prioridad</label>
                                                    <select name="priority" class="form-control">
                                                        <option value="low">Baja</option>
                                                        <option value="medium" selected>Media</option>
                                                        <option value="high">Alta</option>
                                                        <option value="urgent">Urgente</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Operador</label>
                                                    <select name="assigned_to" class="form-control">
                                                        <option value="">Sin asignar</option>
                                                        <% users.forEach(function(user) { %>
                                                            <option value="<%= user.id %>">
                                                                <%= user.names %>
                                                                    <%= user.surnames %>
                                                            </option>
                                                            <% }); %>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>Cliente</label>
                                                    <select name="clientid" class="form-control select2-client"
                                                        style="width:100%">
                                                        <option value="">Ninguno</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="form-group">
                                                    <label>Dirección</label>
                                                    <input type="text" name="address" class="form-control"
                                                        placeholder="Dirección de la tarea">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label>Tipo</label>
                                                    <select name="task_type" class="form-control">
                                                        <option value="installation">Instalación</option>
                                                        <option value="support">Soporte</option>
                                                        <option value="maintenance">Mantenimiento</option>
                                                        <option value="collection">Cobranza</option>
                                                        <option value="other">Otro</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>GPS (Latitud)</label>
                                                    <input type="text" name="latitude" class="form-control"
                                                        placeholder="Ej: -12.0464">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label>GPS (Longitud)</label>
                                                    <input type="text" name="longitude" class="form-control"
                                                        placeholder="Ej: -77.0428">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Descripción</label>
                                            <textarea name="description" class="form-control" rows="2"
                                                placeholder="Detalles de la tarea..."></textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-white"
                                            data-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i>
                                            Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
        </div>

        <%- include('../resources/includes/footer') %>

            <style>
                .thead-dark th {
                    background-color: #2d353c;
                    color: #fff;
                    font-weight: 600;
                    text-transform: uppercase;
                    font-size: 11px;
                    letter-spacing: 0.5px;
                }

                .btn-group .btn.active {
                    background-color: #348fe2;
                    border-color: #348fe2;
                    color: #fff;
                }

                .btn-group .btn {
                    border-color: #d5dbe0;
                }
            </style>

            <script>
                $(document).ready(function () {
                    // Initialize Select2 for clients
                    $('.select2-client').select2({
                        dropdownParent: $('#modalTask'),
                        ajax: {
                            url: '/customers/list',
                            dataType: 'json',
                            delay: 250,
                            data: function (params) { return { search: params.term }; },
                            processResults: function (data) {
                                return {
                                    results: data.data.map(function (item) {
                                        return { id: item.id, text: item.names + ' ' + item.surnames };
                                    })
                                };
                            }
                        },
                        placeholder: 'Buscar cliente...',
                        allowClear: true,
                        minimumInputLength: 2
                    });

                    // DataTable
                    var table = $('#tableTasks').DataTable({
                        ajax: { url: '/tasks/list', dataSrc: 'data' },
                        columns: [
                            {
                                data: 'title',
                                render: function (data, type, row) {
                                    return '<strong>' + data + '</strong>' +
                                        (row.task_type ? '<br><small class="text-muted">' + getTaskTypeName(row.task_type) + '</small>' : '');
                                }
                            },
                            {
                                data: 'status',
                                render: function (data) {
                                    var labels = { pending: 'PENDIENTE', in_progress: 'EN PROCESO', completed: 'COMPLETADO' };
                                    var colors = { pending: 'warning', in_progress: 'info', completed: 'success' };
                                    return '<span class="badge badge-' + colors[data] + '">' + labels[data] + '</span>';
                                }
                            },
                            {
                                data: 'due_date',
                                render: function (data) {
                                    return data ? new Date(data).toLocaleDateString('es-PE') : '-';
                                }
                            },
                            {
                                data: 'duration_hours',
                                render: function (data, type, row) {
                                    var hours = data || 0;
                                    var mins = row.duration_minutes || 0;
                                    return hours + 'h ' + mins + 'm';
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    return data.assigned_names ? data.assigned_names + ' ' + data.assigned_surnames : '<span class="text-muted">Sin asignar</span>';
                                }
                            },
                            {
                                data: null,
                                render: function (data) {
                                    return data.client_names ? data.client_names : '-';
                                }
                            },
                            {
                                data: null,
                                orderable: false,
                                render: function (data) {
                                    return '<div class="btn-group btn-group-sm">' +
                                        '<button class="btn btn-info btn-edit" data-id="' + data.id + '"><i class="fa fa-edit"></i></button>' +
                                        '<button class="btn btn-success btn-complete" data-id="' + data.id + '" ' + (data.status === 'completed' ? 'disabled' : '') + '><i class="fa fa-check"></i></button>' +
                                        '<button class="btn btn-danger btn-delete" data-id="' + data.id + '"><i class="fa fa-trash"></i></button>' +
                                        '</div>';
                                }
                            }
                        ],
                        order: [[2, 'asc']],
                        pageLength: 15,
                        language: { url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Spanish.json' },
                        dom: '<"row"<"col-sm-12"tr>><"row"<"col-sm-5"i><"col-sm-7"p>>'
                    });

                    function getTaskTypeName(type) {
                        var types = { installation: 'Instalación', support: 'Soporte', maintenance: 'Mantenimiento', collection: 'Cobranza', other: 'Otro' };
                        return types[type] || type;
                    }

                    // Toggle buttons
                    $('#btnAllTasks, #btnMyTasks, #btnTimeline, #btnTasksView').click(function () {
                        $('.btn-group .btn').removeClass('active');
                        $(this).addClass('active');
                    });

                    // Entries per page
                    $('#entriesPerPage').change(function () {
                        table.page.len($(this).val()).draw();
                    });

                    // Search
                    $('#searchInput').on('keyup', function () {
                        table.search($(this).val()).draw();
                    });

                    // Filter by status
                    $('#filterStatus').change(function () {
                        var status = $(this).val();
                        if (status) {
                            table.ajax.url('/tasks/list?status=' + status).load();
                        } else {
                            table.ajax.url('/tasks/list').load();
                        }
                    });

                    // Set default date
                    var today = new Date().toISOString().slice(0, 16);
                    $('input[name="due_date"]').val(today);

                    // Form submit
                    $('#formTask').submit(function (e) {
                        e.preventDefault();
                        var id = $('#taskId').val();
                        var url = id ? '/tasks/update' : '/tasks/create';
                        $.post(url, $(this).serialize(), function (res) {
                            if (res.success) {
                                $.gritter.add({ title: 'Éxito', text: res.message, class_name: 'gritter-success' });
                                $('#modalTask').modal('hide');
                                $('#formTask')[0].reset();
                                $('#taskId').val('');
                                table.ajax.reload();
                            } else {
                                $.gritter.add({ title: 'Error', text: res.message, class_name: 'gritter-error' });
                            }
                        });
                    });

                    // Edit task
                    $(document).on('click', '.btn-edit', function () {
                        var id = $(this).data('id');
                        $.get('/tasks/select/' + id, function (res) {
                            if (res.success) {
                                var task = res.task;
                                $('#taskId').val(task.id);
                                $('input[name="title"]').val(task.title);
                                $('textarea[name="description"]').val(task.description);
                                $('select[name="task_type"]').val(task.task_type);
                                $('select[name="status"]').val(task.status);
                                $('select[name="assigned_to"]').val(task.assigned_to);
                                $('select[name="priority"]').val(task.priority);
                                $('input[name="address"]').val(task.address);
                                if (task.due_date) {
                                    $('input[name="due_date"]').val(new Date(task.due_date).toISOString().slice(0, 16));
                                }
                                $('.modal-title').html('<i class="fa fa-edit mr-2"></i>Editar Tarea');
                                $('#modalTask').modal('show');
                            }
                        });
                    });

                    // Complete task
                    $(document).on('click', '.btn-complete', function () {
                        var id = $(this).data('id');
                        $.confirm({
                            title: 'Completar Tarea',
                            content: '¿Marcar como completada?',
                            type: 'green',
                            buttons: {
                                confirmar: {
                                    btnClass: 'btn-success',
                                    action: function () {
                                        $.post('/tasks/status', { id: id, status: 'completed' }, function (res) {
                                            if (res.success) {
                                                $.gritter.add({ title: 'Éxito', text: 'Tarea completada', class_name: 'gritter-success' });
                                                table.ajax.reload();
                                            }
                                        });
                                    }
                                },
                                cancelar: function () { }
                            }
                        });
                    });

                    // Delete task
                    $(document).on('click', '.btn-delete', function () {
                        var id = $(this).data('id');
                        $.confirm({
                            title: 'Eliminar Tarea',
                            content: '¿Está seguro?',
                            type: 'red',
                            buttons: {
                                eliminar: {
                                    btnClass: 'btn-danger',
                                    action: function () {
                                        $.post('/tasks/remove', { id: id }, function (res) {
                                            if (res.success) {
                                                $.gritter.add({ title: 'Éxito', text: 'Tarea eliminada', class_name: 'gritter-success' });
                                                table.ajax.reload();
                                            }
                                        });
                                    }
                                },
                                cancelar: function () { }
                            }
                        });
                    });

                    // Reset modal on close
                    $('#modalTask').on('hidden.bs.modal', function () {
                        $('#formTask')[0].reset();
                        $('#taskId').val('');
                        $('.modal-title').html('<i class="fa fa-tasks mr-2"></i>Nueva Tarea');
                    });
                });
            </script>
